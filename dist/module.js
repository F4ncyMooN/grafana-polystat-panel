define(["lodash","d3","@grafana/data","app/core/utils/kbn","jquery","app/plugins/sdk","app/core/time_series2","app/core/core_module"],(function(t,e,a,r,o,i,s,n){return function(t){var e={};function a(r){if(e[r])return e[r].exports;var o=e[r]={i:r,l:!1,exports:{}};return t[r].call(o.exports,o,o.exports,a),o.l=!0,o.exports}return a.m=t,a.c=e,a.d=function(t,e,r){a.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:r})},a.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},a.t=function(t,e){if(1&e&&(t=a(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(a.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var o in t)a.d(r,o,function(e){return t[e]}.bind(null,o));return r},a.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return a.d(e,"a",e),e},a.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},a.p="/",a(a.s=10)}([function(e,a){e.exports=t},function(t,a){t.exports=e},function(t,e){t.exports=a},function(t,e){t.exports=r},function(t,e){t.exports=o},function(t,e){t.exports=i},function(t,e){t.exports=s},function(t,e){t.exports=n},,,function(t,e,a){"use strict";a.r(e);
/*! *****************************************************************************
Copyright (c) Microsoft Corporation. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at http://www.apache.org/licenses/LICENSE-2.0

THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
MERCHANTABLITY OR NON-INFRINGEMENT.

See the Apache Version 2.0 License for specific language governing permissions
and limitations under the License.
***************************************************************************** */
var r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var a in e)e.hasOwnProperty(a)&&(t[a]=e[a])})(t,e)};var o=function(){return(o=Object.assign||function(t){for(var e,a=1,r=arguments.length;a<r;a++)for(var o in e=arguments[a])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t}).apply(this,arguments)};function i(t,e){var a="function"==typeof Symbol&&t[Symbol.iterator];if(!a)return t;var r,o,i=a.call(t),s=[];try{for(;(void 0===e||e-- >0)&&!(r=i.next()).done;)s.push(r.value)}catch(t){o={error:t}}finally{try{r&&!r.done&&(a=i.return)&&a.call(i)}finally{if(o)throw o.error}}return s}var s=a(5),n=a(0),l=a.n(n),h=a(4),p=a.n(h),u=a(3),c=a.n(u),d=a(6),m=a.n(d),f=a(2),v=a(1),g=Math.PI/3,y=[0,g,2*g,3*g,4*g,5*g];function b(t){return t[0]}function x(t){return t[1]}function w(t,e){if(l.a.isNumber(e))return{decimals:e,scaledDecimals:null};var a,r=t/2,o=-Math.floor(Math.log(r)/Math.LN10),i=Math.pow(10,-o),s=r/i;s<1.5?a=1:s<3?(a=2,s>2.25&&(a=2.5,++o)):a=s<7.5?5:10,a*=i,Math.floor(t)===t&&(o=0);var n={decimals:0,scaledDecimals:0};return n.decimals=Math.max(0,o),n.scaledDecimals=n.decimals-Math.floor(Math.log(a)/Math.LN10)+2,n}function C(t,e){var a=document.createElement("canvas").getContext("2d");return a.font=e,a.measureText(t).width}function S(t){if(!t.startsWith("rgb"))return t;var e="#FFFFFF";try{e="#"+t.split("(")[1].split(")")[0].split(",").map((function(t){return 1===(t=parseInt(t,10).toString(16)).length?"0"+t:t})).join("")}catch(t){return e}return e}var R,T=function(){function t(t,e,a){this.r=t,this.g=e,this.b=a}return t.prototype.asHex=function(){return"#"+((1<<24)+(this.r<<16)+(this.g<<8)+this.b).toString(16).slice(1)},t.prototype.asRGB=function(){return"rgb("+this.r+","+this.g+","+this.b+")"},t.prototype.blendWith=function(e,a){return new t(Math.round(e.r*(1-a)+this.r*a),Math.round(e.g*(1-a)+this.g*a),Math.round(e.b*(1-a)+this.b*a))},t.prototype.Mul=function(e,a){return new t(Math.round(e.r/255*this.r*a),Math.round(e.g/255*this.g*a),Math.round(e.b/255*this.b*a))},t.prototype.fromHex=function(t){t=t.substring(1,7);var e=parseInt(t,16);this.r=e>>16&255,this.g=e>>8&255,this.b=255&e},t.createGradients=function(e){for(var a=[],r=new t(255,255,255),o=0;o<e.length;o++){var i=new t(0,0,0);i.fromHex(e[o].color);var s=i.Mul(r,.7);a.push({start:i.asHex(),end:s.asHex()})}return a},t}(),D=function(){};!function(t){t.HEXAGON_POINTED_TOP="hexagon_pointed_top",t.CIRCLE="circle",t.SQUARE="square"}(R||(R={}));var N=function(){function t(t,e,a,r,o,i){this.SQRT3=1.7320508075688772,this.width=t,this.height=e,this.numColumns=a,this.numRows=r,this.maxColumnsUsed=0,this.maxRowsUsed=0,this.displayLimit=o,this.shape=i,this.radius=0}return t.prototype.setRadius=function(t){this.radius=t},t.prototype.setHeight=function(t){this.height=t},t.prototype.setWidth=function(t){this.width=t},t.prototype.generateHexagonPointedTopLayout=function(){return this.radius=this.getHexFlatTopRadius(),{}},t.prototype.generateUniformLayout=function(){return this.radius=this.getUniformRadius(),{}},t.prototype.getHexFlatTopRadius=function(){var t=v.min([this.width/((this.numColumns+.5)*this.SQRT3),this.height/(1.5*(this.numRows+1/3))]);return t-=0,this.truncateFloat(t)},t.prototype.getHexFlatTopDiameters=function(){var t=this.getHexFlatTopRadius();return{diameterX:this.truncateFloat(t*this.SQRT3),diameterY:this.truncateFloat(2*t)}},t.prototype.getUniformDiameters=function(){var t=this.getUniformRadius();return{diameterX:2*t,diameterY:2*t}},t.prototype.getUniformRadius=function(){var t=this.width/this.maxColumnsUsed*.5,e=this.height/this.maxRowsUsed*.5,a=t;return a>e&&(a=e),a-=0,this.truncateFloat(a)},t.prototype.generatePossibleColumnAndRowsSizes=function(t,e,a){if(e&&t){var r=Math.sqrt(a);this.width>this.height?(this.numColumns=Math.ceil(this.width/this.height*r),this.numColumns<1?this.numColumns=1:this.numColumns>a&&(this.numColumns=a),this.numRows=Math.ceil(a/this.numColumns),this.numRows<1&&(this.numRows=1)):(this.numRows=Math.ceil(this.height/this.width*r),this.numRows<1?this.numRows=1:this.numRows>a&&(this.numRows=a),this.numColumns=Math.ceil(a/this.numRows),this.numColumns<1&&(this.numColumns=1))}else e?(this.numRows=Math.ceil(a/this.numColumns),this.numRows<1&&(this.numRows=1)):t&&(this.numColumns=Math.ceil(a/this.numRows),this.numColumns<1&&(this.numColumns=1))},t.prototype.generateActualColumnAndRowUsage=function(t,e){for(var a=0,r=0,o=0,i=0,s=0;s<this.numRows;s++)if((!e||a<e)&&a<t.length){r+=1,o=0;for(var n=0;n<this.numColumns;n++)(!e||a<e)&&a<t.length&&((o+=1)>i&&(i=o),a++)}this.maxRowsUsed=r,this.maxColumnsUsed=i},t.prototype.shapeToCoordinates=function(t,e,a,r){switch(t){case R.HEXAGON_POINTED_TOP:var o=e*a*this.SQRT3;return r%2==1&&(o+=e*this.SQRT3/2),[o,e*r*1.5];case R.CIRCLE:case R.SQUARE:return[e*a*2,e*r*2];default:return[e*a*1.75,e*r*1.5]}},t.prototype.generatePoints=function(t,e,a){var r=[];if(void 0===t)return r;var o=0,i=0,s=0;if(this.numRows===1/0)return r;if(isNaN(this.numColumns))return r;for(var n=0;n<this.numRows;n++)if((!e||r.length<e)&&r.length<t.length){o+=1,i=0;for(var l=0;l<this.numColumns;l++)(!e||r.length<e)&&r.length<t.length&&((i+=1)>s&&(s=i),r.push(this.shapeToCoordinates(a,this.radius,l,n)))}return this.maxRowsUsed=o,this.maxColumnsUsed=s,r},t.prototype.generateUniformPoints=function(t,e){var a=[];if(void 0===t)return a;var r=0,o=0,i=0,s=1,n=1;if(this.numRows===1/0)return a;if(isNaN(this.numColumns))return a;for(var l=0;l<this.numRows;l++)if((!e||a.length<e)&&a.length<t.length){r+=1,o=0;for(var h=0;h<this.numColumns;h++)(!e||a.length<e)&&a.length<t.length&&((o+=1)>i&&(i=o),a.push({x:s,y:n,width:2*this.radius,height:2*this.radius}),s+=2*this.radius);s=1,n+=2*this.radius}return this.maxRowsUsed=r,this.maxColumnsUsed=i,a},t.prototype.getRadius=function(){return this.radius},t.prototype.generateRadius=function(t){var e=0;switch(t){case R.HEXAGON_POINTED_TOP:e=this.getHexFlatTopRadius();break;case R.CIRCLE:case R.SQUARE:e=this.getUniformRadius();break;default:e=this.getHexFlatTopRadius()}return this.radius=e,e},t.prototype.truncateFloat=function(t){if(t===1/0||isNaN(t))return 0;var e=t.toString().match(/^-?\d+(?:\.\d{0,2})?/)[0];return Number(e)},t.prototype.getOffsets=function(t,e){switch(t){case R.HEXAGON_POINTED_TOP:return this.getOffsetsHexagonPointedTop(e);case R.SQUARE:return this.getOffsetsSquare(e);case R.CIRCLE:default:return this.getOffsetsUniform(e)}},t.prototype.getOffsetsHexagonPointedTop=function(t){var e=v.min([this.width/((this.numColumns+.5)*this.SQRT3),this.height/(1.5*(this.numRows+1/3))]);e=this.truncateFloat(e);var a=this.truncateFloat(e*this.SQRT3),r=this.truncateFloat(2*e),o=.5*r,i=this.getOddEvenCountForRange(1,this.maxRowsUsed),s=i.oddCount*r+i.evenCount*r*.5,n=(this.height-s)/2;n=-(n+o);var l=.5*a,h=0;this.numRows>1&&t>=2*this.maxColumnsUsed&&(h=.5);var p=(this.numColumns+h)*a,u=(this.width-p)/2;return{xoffset:u=-(u+l),yoffset:n}},t.prototype.getOffsetsUniform=function(t){var e=this.getDiameters(),a=e.diameterX,r=e.diameterY,o=this.truncateFloat(a),i=this.truncateFloat(r),s=.5*i,n=this.maxRowsUsed*i,l=(this.height-n)/2;l=-(l+s);var h=.5*o,p=this.numColumns*o,u=(this.width-p)/2;return{xoffset:u=-(u+h),yoffset:l}},t.prototype.getOffsetsSquare=function(t){var e=this.getDiameters(),a=e.diameterX,r=e.diameterY,o=this.truncateFloat(a),i=this.truncateFloat(r),s=this.maxRowsUsed*i,n=(this.height-s)/2;n=-(n+0);var l=this.numColumns*o,h=(this.width-l)/2;return{xoffset:h=-(h+0),yoffset:n}},t.prototype.getOddEvenCountForRange=function(t,e){var a=(e-t)/2;return e%2==0&&t%2==0||a++,{oddCount:a,evenCount:e-t+1-a}},t.prototype.getDiameters=function(){switch(this.shape){case R.HEXAGON_POINTED_TOP:return this.getHexFlatTopDiameters();case R.SQUARE:case R.CIRCLE:default:return this.getUniformDiameters()}},t}();function M(t){return!("showName"in t)||t.showName}var E=function(){function t(t,e,a,r){this.minFont=8,this.maxFont=240,this.templateSrv=t,this.svgContainer=e,this.d3DivId=a,this.data=r.data,this.opt=r,this.purelight=new T(255,255,255),this.data=this.opt.data,this.lm=new N(this.opt.width,this.opt.height,r.columns||6,r.rows||6,this.opt.displayLimit,this.opt.polystat.shape),this.lm.generatePossibleColumnAndRowsSizes(this.opt.columnAutoSize,this.opt.rowAutoSize,this.data.length),this.lm.generateActualColumnAndRowUsage(this.data,r.displayLimit),!r.radiusAutoSize&&r.radius?this.lm.setRadius(r.radius):this.lm.generateRadius(this.opt.polystat.shape),this.calculatedPoints=this.lm.generatePoints(this.data,r.displayLimit,this.opt.polystat.shape)}return t.prototype.computeTextFontSize=function(t,e,a,r){return function(t,e,a,r,o,i){var s=e.replace("?",i),n=C(t,s);if(n<=(a*=.95)&&i<=r)return i;for(var l=i;l>=o;l--)if((n=C(t,s=e.replace("?",l)))<a&&l<=r)return Math.ceil(l);return 0}(t,"?px sans-serif",a,r/e,this.minFont,this.maxFont)},t.prototype.update=function(t){t&&(this.data=t)},t.prototype.draw=function(){for(var t=this,e=0,a=0,r=this.opt.width,o=this.opt.height,i=function(){var t,e,a,r=0,o=0,i=1,s=1,n=b,l=x;function h(t){var r,o={},i=[],s=t.length;for(r=0;r<s;++r)if(!isNaN(p=+n.call(null,h=t[r],r,t))&&!isNaN(u=+l.call(null,h,r,t))){var h,p,u,c=Math.round(u/=a),d=Math.round(p=p/e-(1&c)/2),m=u-c;if(3*Math.abs(m)>1){var f=p-d,v=d+(p<d?-1:1)/2,g=c+(u<c?-1:1),y=p-v,b=u-g;f*f+m*m>y*y+b*b&&(d=v+(1&c?1:-1)/2,c=g)}var x=d+"-"+c,w=o[x];w?w.push(h):(i.push(w=o[x]=[h]),w.x=(d+(1&c)/2)*e,w.y=c*a)}return i}function p(t){var e=0,a=0;return y.map((function(r){var o=Math.sin(r)*t,i=-Math.cos(r)*t,s=o-e,n=i-a;return e=o,a=i,[s,n]}))}return h.hexagon=function(e){return"m"+p(null==e?t:+e).join("l")+"z"},h.centers=function(){for(var n=[],l=Math.round(o/a),h=Math.round(r/e),p=l*a;p<s+t;p+=a,++l)for(var u=h*e+(1&l)*e/2;u<i+e/2;u+=e)n.push([u,p]);return n},h.mesh=function(){var e=p(t).slice(0,4).join("l");return h.centers().map((function(t){return"M"+t+"m"+e})).join("")},h.x=function(t){return arguments.length?(n=t,h):n},h.y=function(t){return arguments.length?(l=t,h):l},h.radius=function(r){return arguments.length?(e=2*(t=+r)*Math.sin(g),a=1.5*t,h):t},h.size=function(t){return arguments.length?(r=o=0,i=+t[0],s=+t[1],h):[i-r,s-o]},h.extent=function(t){return arguments.length?(r=+t[0][0],o=+t[0][1],i=+t[1][0],s=+t[1][1],h):[[r,o],[i,s]]},h.radius(1)}().radius(this.lm.generateRadius(this.opt.polystat.shape)).extent([[0,0],[r,o]]),s=this.lm.getDiameters(),n=s.diameterX,l=s.diameterY,h=this.lm.getOffsets(this.opt.polystat.shape,this.data.length),p=h.xoffset,u=h.yoffset,c=v.select("body").append("div").attr("id",this.d3DivId+"-tooltip").attr("class","polystat-panel-tooltip").style("opacity",0),d=v.select(this.svgContainer).attr("width",r+"px").attr("height",o+"px").append("svg").attr("xmlns:xlink","http://www.w3.org/1999/xlink").attr("width","100%").attr("height","100%").attr("viewBox",p+","+u+", "+r+", "+o).style("border","0px solid white").attr("id",this.d3DivId).append("g").attr("transform","translate("+a+","+e+")"),m=this.data,f=d.append("defs"),w=T.createGradients(m),C=0;C<w.length;C++){var S=f.append("linearGradient").attr("id",this.d3DivId+"linear-gradient-state-data-"+C);S.attr("x1","30%").attr("y1","30%").attr("x2","70%").attr("y2","70%"),S.append("stop").attr("offset","0%").attr("stop-color",w[C].start),S.append("stop").attr("offset","100%").attr("stop-color",w[C].end)}var D=new T(82,194,52),N=D.Mul(this.purelight,.7),E=f.append("linearGradient").attr("id",this.d3DivId+"linear-gradient-state-ok");E.attr("x1","30%").attr("y1","30%").attr("x2","70%").attr("y2","70%"),E.append("stop").attr("offset","0%").attr("stop-color",D.asHex()),E.append("stop").attr("offset","100%").attr("stop-color",N.asHex());var O=new T(255,200,55),F=O.Mul(this.purelight,.7),k=f.append("linearGradient").attr("id",this.d3DivId+"linear-gradient-state-warning");k.attr("x1","30%").attr("y1","30%").attr("x2","70%").attr("y2","70%"),k.append("stop").attr("offset","0%").attr("stop-color",O.asHex()),k.append("stop").attr("offset","100%").attr("stop-color",F.asHex());var L=new T(229,45,39),z=L.Mul(this.purelight,.7),P=f.append("linearGradient").attr("id",this.d3DivId+"linear-gradient-state-critical");P.attr("x1","30%").attr("y1","30%").attr("x2","70%").attr("y2","70%"),P.append("stop").attr("offset","0%").attr("stop-color",L.asHex()),P.append("stop").attr("offset","100%").attr("stop-color",z.asHex());var _=f.append("linearGradient").attr("id",this.d3DivId+"linear-gradient-state-unknown");_.attr("x1","30%").attr("y1","30%").attr("x2","70%").attr("y2","70%"),_.append("stop").attr("offset","0%").attr("stop-color","#73808A"),_.append("stop").attr("offset","100%").attr("stop-color","#757F9A");var A=null,I=n,U=l/2,V=n*l;n<l&&(V=n*n),l<n&&(V=l*l);var $=v.symbol().size(V);switch(this.opt.polystat.shape){case R.HEXAGON_POINTED_TOP:A=i.hexagon(this.lm.getRadius());break;case R.CIRCLE:A=$.type(v.symbolCircle);break;case R.SQUARE:A=$.type(v.symbolSquare);break;default:A=i.hexagon(this.lm.getRadius())}var B=this.opt.polystat.fontSize,H=this.opt.polystat.fontSize;if(this.opt.polystat.fontAutoScale){var j="";for(C=0;C<this.data.length;C++)this.data[C].name.length>j.length&&(j=this.data[C].name);var G="";for(C=0;C<this.data.length;C++){this.data[C].valueFormatted.length>G.length&&(G=this.data[C].valueFormatted);var W=this.data[C].members.length;if(W>0)for(var Q=0;Q<W;){var X=this.formatValueContent(C,Q,this);X&&X.length>G.length&&(G=X),Q++}}B=this.computeTextFontSize(j,2,I,U),(H=this.computeTextFontSize(G,2,I,U))>B&&(H=B)}var q=U/2/2+H/2,Y=H/2,J=-U/2/2+B/2,K=B/2,Z=0,tt=0,et=null,at="hexagon";switch(this.opt.polystat.shape){case R.HEXAGON_POINTED_TOP:et=d.selectAll("."+at).data(i(this.calculatedPoints)).enter();break;case R.CIRCLE:at="circle";var rt=this.lm.generateRadius(this.opt.polystat.shape);(et=d.selectAll(".circle").data(this.calculatedPoints)).enter().append("circle").attr("class","circle").attr("cx",(function(t){return t[0]})).attr("cy",(function(t){return t[1]})).attr("r",rt),et=d.selectAll(".circle").data(m);break;case R.SQUARE:at="square";var ot=this.lm.generateRadius(this.opt.polystat.shape);(et=d.selectAll(".rect").data(this.calculatedPoints)).enter().append("rect").attr("class","rect").attr("x",(function(t){return t[0]})).attr("y",(function(t){return t[1]})).attr("height",2*ot).attr("width",2*ot),et=d.selectAll(".rect").data(m)}et.each((function(e,a,r){var o,i,s=v.select(r[a]),n=function(t){var e=t.clickThrough;return!0===t.sanitizeURLEnabled&&t.sanitizedURL.length>0&&(e=t.sanitizedURL),e}(m[a]);n.length>0&&(s=s.append("a").attr("target",(o=m[a],i="_self",!0===o.newTabEnabled&&(i="_blank"),i)).attr("xlink:href",n));var l=m[a].color;switch(t.opt.polystat.gradientEnabled&&(l='url("#'+t.d3DivId+"linear-gradient-state-data-"+a+'")'),t.opt.polystat.shape){case R.HEXAGON_POINTED_TOP:s=s.append("path").attr("transform",(function(t){return"translate("+t.x+","+t.y+")"})).attr("d",A).attr("stroke",t.opt.polystat.polygonBorderColor).attr("stroke-width",t.opt.polystat.polygonBorderSize+"px").style("fill",l);break;case R.CIRCLE:s.join("circle").attr("stroke",t.opt.polystat.polygonBorderColor).attr("stroke-width",t.opt.polystat.polygonBorderSize+"px").style("fill",l);break;case R.SQUARE:s.join("square").attr("stroke",t.opt.polystat.polygonBorderColor).attr("stroke-width",t.opt.polystat.polygonBorderSize+"px").style("fill",l)}s.on("mousemove",(function(){var t=Math.max(document.documentElement.clientWidth,window.innerWidth||0),e=v.event.pageX-50;e<0&&(e=0),e+200>t&&(e=t-200);var a=v.event.pageY+5;c.style("left",e+"px").style("top",a+"px")})).on("mouseover",(function(e){c.transition().duration(200).style("opacity",.9),c.html(t.opt.tooltipContent[a]).style("font-size",t.opt.tooltipFontSize).style("font-family",t.opt.tooltipFontType).style("left",e.x-5+"px").style("top",e.y-5+"px")})).on("mouseout",(function(){c.transition().duration(500).style("opacity",0)}))}));var it=null;switch(this.opt.polystat.shape){case R.HEXAGON_POINTED_TOP:it=d.selectAll("text.toplabel").data(i(this.calculatedPoints));break;case R.CIRCLE:it=d.selectAll("text.toplabel").data(this.miscbin(this.calculatedPoints));break;case R.SQUARE:it=d.selectAll("text.toplabel").data(this.miscbin(this.calculatedPoints)),q=l/1.5+H/2,Y=l/1.5+H/2,J=l/4+B/2,K=B/2,Z=n/2,tt=n/2}it.enter().append("text").attr("class","toplabel").attr("x",(function(t){return t.x+Z})).attr("y",(function(t,e){var a=m[e],r=K;return function(t){return!("showValue"in t)||t.showValue}(a)&&(r=J),t.y+r})).attr("text-anchor","middle").attr("font-family",this.opt.polystat.fontType).attr("font-size",B+"px").attr("fill","black").style("pointer-events","none").text((function(t,e){var a=m[e];return M(a)?a.name:""}));var st=0;it.enter().append("text").attr("class",(function(t,e){return"valueLabel"+e})).attr("x",(function(t){return t.x+tt})).attr("y",(function(t,e){var a=m[e],r=Y;return M(a)&&(r=q),t.y+r})).attr("text-anchor","middle").attr("font-family",this.opt.polystat.fontType).attr("fill","black").attr("font-size",H+"px").style("pointer-events","none").text((function(e,a){for(var r=0,o=t.data.length,i=null;null===i&&r<o;)i=t.formatValueContent(a,st+r,t),r++;return d.select("text.valueLabel"+a).attr("font-size",H+"px"),v.interval((function(){var e=d.select("text.valueLabel"+a),r=a;e.text((function(){e.attr("font-size",H+"px");for(var a=null,o=0,i=2*t.data.length;null===a&&o<i;)a=t.formatValueContent(r,st+o,t),o++;return null===a?"":(""===a&&(a=""),a)})),st++}),t.opt.animationSpeed),i}))},t.prototype.miscbin=function(t){for(var e=0;e<t.length;e++)t[e].x=t[e][0],t[e].y=t[e][1];return t},t.prototype.formatValueContent=function(t,e,a){var r=a.data[t];if(void 0===r)return"";if(r.hasOwnProperty("showValue")&&!r.showValue)return"";if(!r.hasOwnProperty("valueFormatted"))return"";switch(r.animateMode){case"all":break;case"triggered":if(r.thresholdLevel<1)return""}var o=r.valueFormatted;if(!o)return null;r.prefix&&r.prefix.length>0&&(o=r.prefix+" "+o),r.suffix&&r.suffix.length>0&&(o=o+" "+r.suffix);var i=r.members.length;if(i>0){var s=-1;if("all"===r.animateMode)s=e%i;else{void 0===r.triggerCache&&(r.triggerCache=this.buildTriggerCache(r));var n=e%r.triggerCache.length;s=r.triggerCache[n].index}var l=r.members[s];o=l.name+": "+l.valueFormatted,l.prefix&&l.prefix.length>0&&(o=l.prefix+" "+o),l.suffix&&l.suffix.length>0&&(o=o+" "+l.suffix)}if(o&&o.length>0)try{o=a.templateSrv.replaceWithText(o)}catch(t){console.log("ERROR: template server threw error: "+t)}return o},t.prototype.buildTriggerCache=function(t){for(var e=[],a=0;a<t.members.length;a++){var r=t.members[a];if(r.thresholdLevel>0){var o={index:a,name:r.name,value:r.value,thresholdLevel:r.thresholdLevel};e.push(o)}}return e=l.a.orderBy(e,["thresholdLevel","value","name"],["desc","desc","asc"])},t}();function O(t,e){var a=(e=e||{}).delimiter||".",r=e.maxDepth||3,o=1,i={};return function t(s,n){Object.keys(s).forEach((function(l){var h=s[l],p=e.safe&&Array.isArray(h),u="[object Object]"===Object.prototype.toString.call(h),c=n?n+a+l:l;if(e.maxDepth||(r=o+1),!p&&u&&Object.keys(h).length&&o<r)return++o,t(h,c);i[c]=h}))}(t,null),i}var F=function(){function t(t,e){if(null!==e){this.animateMode="all",this.displayMode="all",this.operatorName=t,this.name=e.alias;var a=this.getValueByOperator(t,e);this.value=a,this.valueFormatted=a,this.stats=e.stats,this.timestamp=e.datapoints[e.datapoints.length-1][1],this.prefix="",this.suffix="",this.seriesRaw=null,this.color="green",this.clickThrough="",this.sanitizedURL="",this.newTabEnabled=!0,this.sanitizeURLEnabled=!0,this.isComposite=!1,this.members=[],this.thresholdLevel=0,this.showName=!0,this.showValue=!0}}return t.prototype.getValueByOperator=function(t,e){var a=e.stats.avg;switch(t){case"avg":a=e.stats.avg;break;case"count":a=e.stats.count;break;case"current":a=e.stats.current;break;case"delta":a=e.stats.delta;break;case"diff":a=e.stats.diff;break;case"first":a=e.stats.first;break;case"logmin":a=e.stats.logmin;break;case"max":a=e.stats.max;break;case"min":a=e.stats.min;break;case"name":a=e.metricName;break;case"time_step":a=e.stats.timeStep;break;case"last_time":a=e.timestamp;break;case"total":a=e.stats.total;break;default:a=e.stats.avg}return a},t.prototype.shallowClone=function(){var e=new t(this.operatorName,null);return e.operatorName=this.operatorName,e.thresholdLevel=this.thresholdLevel,e.value=this.value,e.valueFormatted=this.valueFormatted,e.name=this.name,e.timestamp=this.timestamp,e.prefix=this.prefix,e.suffix=this.suffix,e.seriesRaw=null,e.color=this.color,e.clickThrough=this.clickThrough,e.newTabEnabled=this.newTabEnabled,e.sanitizedURL=this.sanitizedURL,e.sanitizeURLEnabled=this.sanitizeURLEnabled,e.isComposite=this.isComposite,e.members=[],e},t.prototype.deepClone=function(){var e=new t(this.operatorName,null);return e.operatorName=this.operatorName,e.thresholdLevel=this.thresholdLevel,e.value=this.value,e.valueFormatted=this.valueFormatted,e.name=this.name,e.timestamp=this.timestamp,e.prefix=this.prefix,e.suffix=this.suffix,e.seriesRaw=this.seriesRaw,e.color=this.color,e.clickThrough=this.clickThrough,e.sanitizedURL=this.sanitizedURL,e.newTabEnabled=this.newTabEnabled,e.sanitizeURLEnabled=this.sanitizeURLEnabled,e.isComposite=this.isComposite,e.members=[],e},t}(),k=function(){function t(){}return t.TimeSeriesToPolystat=function(t,e){return new F(t,e)},t.GetColumnsJSONData=function(t){if(!t||0===t.length)return[];for(var e={},a=0;a<t.length;a++){var r=t[a];if("docs"===r.type)for(var o=Math.min(r.datapoints.length,100),i=0;i<o;i++){var s=O(r.datapoints[i],null);for(var n in s)s.hasOwnProperty(n)&&(e[n]=!0)}}return l.a.map(e,(function(t,e){return{text:e,value:t}}))},t}();function L(t,e,a){var r=t,o=P(t.operatorName,t),i=P(e.operatorName,e),s=z(t.thresholds,o,a),n=z(e.thresholds,i,a);if(n.thresholdLevel>s.thresholdLevel&&(r=e),3===s.thresholdLevel)switch(n.thresholdLevel){case 1:case 2:r=e}return r}function z(t,e,a){var r=a;if(null===e)return{thresholdLevel:3,color:"#808080"};var o=-1;if(void 0===t)return{thresholdLevel:o,color:a};var i=t.length;if(0===i)return{thresholdLevel:o,color:a};var s=t[i-1];if(e>=s.value&&(o=s.state,r=s.color),1===t.length)return{thresholdLevel:o,color:r};for(var n=i-1;n>0;n--){var l=t[n],h=t[n-1];h.value<=e&&e<l.value&&o<h.state&&(o=h.state,r=h.color)}return-1===o&&(o=t[0].state,r=t[0].color),{thresholdLevel:o,color:r}}function P(t,e){var a=e.stats.avg;switch(t){case"avg":a=e.stats.avg;break;case"count":a=e.stats.count;break;case"current":a=e.stats.current;break;case"delta":a=e.stats.delta;break;case"diff":a=e.stats.diff;break;case"first":a=e.stats.first;break;case"logmin":a=e.stats.logmin;break;case"max":a=e.stats.max;break;case"min":a=e.stats.min;break;case"name":a=e.metricName;break;case"time_step":a=e.stats.timeStep;break;case"last_time":a=e.timestamp;break;case"total":a=e.stats.total;break;default:a=e.stats.avg}return a}var _=function(){function t(){}return t.tranformSingleMetric=function(t,e,a){if(isNaN(t))return e;for(var r=a[t];e.match(this.cellName);)e=e.replace(this.cellName,r.name);for(;e.match(this.cellValue);)e=e.replace(this.cellValue,encodeURIComponent(r.valueFormatted));for(;e.match(this.cellRawValue);)e=e.replace(this.cellRawValue,r.value.toString());return e},t.tranformNthMetric=function(t,e){for(;t.match(this.nthCellName);){if((o=t.match(this.nthCellName)).length>=2){var a=e[o[1]].name;t=t.replace(this.nthCellName,a)}}for(;t.match(this.nthCellValue);){if((o=t.match(this.nthCellValue)).length>=2){var r=e[o[1]].valueFormatted;t=t.replace(this.nthCellValue,encodeURIComponent(r))}}for(;t.match(this.nthCellRawValue);){var o;if((o=t.match(this.nthCellRawValue)).length>=2){r=e[o[1]].value;t=t.replace(this.nthCellRawValue,r.toString())}}return t},t.tranformComposite=function(t,e){for(;e.match(this.compositeName);)e=e.replace(this.compositeName,t);return e},t.cellName=/\${__cell_name}/,t.cellValue=/\${__cell}/,t.cellRawValue=/\${__cell:raw}/,t.nthCellName=/\${__cell_name_(\d+)}/,t.nthCellValue=/\${__cell_(\d+)}/,t.nthCellRawValue=/\${__cell_(\d+):raw}/,t.compositeName=/\${__composite_name}/,t}(),A=function(){function t(t,e,a,r){var o=this;this.onSetThresholds=function(t){console.log("OVERRIDE (threshold)",t)},this.$scope=t,this.$sanitize=a,this.templateSrv=e,this.activeOverrideIndex=0,this.suggestMetricNames=function(){return l.a.map(o.$scope.ctrl.series,(function(t){return t.alias}))},this.metricOverrides=r;for(var i=0;i<this.metricOverrides.length;i++)void 0===this.metricOverrides[i].label&&(this.metricOverrides[i].label="OVERRIDE "+(i+1))}return t.prototype.addMetricOverride=function(){var t=new D;t.label="OVERRIDE "+(this.metricOverrides.length+1),t.metricName="",t.thresholds=[],t.colors=["#299c46","#e5ac0e","#bf1b00","#ffffff"],t.decimals="",t.enabled=!0,t.unitFormat="short",t.clickThrough="",t.operatorName="avg",t.scaledDecimals=null,t.prefix="",t.suffix="",t.newTabEnabled=!0,t.sanitizeURLEnabled=!0,this.metricOverrides.push(t)},t.prototype.removeMetricOverride=function(t){this.metricOverrides=l.a.without(this.metricOverrides,t);for(var e=0;e<this.metricOverrides.length;e++)this.metricOverrides[e].label="OVERRIDE "+(e+1);this.$scope.ctrl.panel.savedOverrides=this.metricOverrides,this.$scope.ctrl.refresh()},t.prototype.metricNameChanged=function(t){console.log("metricNameChanged: '"+t.metricName+"'"),this.$scope.ctrl.refresh()},t.prototype.toggleHide=function(t){t.enabled=!t.enabled,this.$scope.ctrl.refresh()},t.prototype.matchOverride=function(t){for(var e=this.resolveOverrideTemplates(),a=0;a<e.length;a++){var r=e[a],o=Object(f.stringToJsRegex)(r.metricName),i=t.match(o);if(i&&i.length>0&&r.enabled)return e[a]}},t.prototype.resolveOverrideTemplates=function(){var t=this,e=[],a=/\$(\w+)|\[\[([\s\S]+?)(?::(\w+))?\]\]|\${(\w+)(?:\.([^:^\}]+))?(?::(\w+))?}/g;return this.metricOverrides.forEach((function(r){var i=r.metricName.match(a);i&&i.length>0?i.forEach((function(a){t.templateSrv.replace(a,t.templateSrv.ScopedVars,"csv").split(",").forEach((function(t){var i=r.metricName.replace(a,t);e.push(o(o({},r),{metricName:i}))}))})):e.push(r)})),e},t.prototype.applyOverrides=function(t){for(var e=this.$scope.ctrl.panel.polystat,a=0;a<t.length;a++){var r=this.matchOverride(t[a].name);if(r){var o=t[a];o.operatorName=r.operatorName;var i=P(o.operatorName,o),s=z(r.thresholds&&r.thresholds.length?r.thresholds:e.globalThresholds,i,e.polygonGlobalFillColor);t[a].value=i,t[a].color=s.color,t[a].thresholdLevel=s.thresholdLevel;var n=c.a.valueFormats[r.unitFormat];if(n&&(t[a].valueFormatted=n(t[a].value,r.decimals,r.scaledDecimals),t[a].valueRounded=c.a.roundValue(t[a].value,r.decimals)),t[a].thresholds=r.thresholds,t[a].prefix=r.prefix,t[a].suffix=r.suffix,r.clickThrough&&r.clickThrough.length>0){var l=this.templateSrv.replaceWithText(r.clickThrough);l=_.tranformSingleMetric(a,l,t),l=_.tranformNthMetric(l,t),t[a].clickThrough=l,t[a].newTabEnabled=r.newTabEnabled,t[a].sanitizeURLEnabled=r.sanitizeURLEnabled,r.sanitizeURLEnabled&&(t[a].sanitizedURL=this.$sanitize(t[a].clickThrough))}}else if(e.globalThresholds&&e.globalThresholds.length){s=z(e.globalThresholds,t[a].value,e.polygonGlobalFillColor);t[a].color=s.color,t[a].thresholdLevel=s.thresholdLevel}}},t.prototype.setUnitFormat=function(t,e){t.unitFormat=e.value},t}(),I=function(){},U=function(){function t(t,e,a,r){var o=this;this.$scope=t,this.$sanitize=a,this.templateSrv=e,this.subTabIndex=0,this.suggestMetricNames=function(){return l.a.map(o.$scope.ctrl.series,(function(t){return t.alias}))},this.metricComposites=r;for(var i=0;i<this.metricComposites.length;i++)void 0===this.metricComposites[i].label&&(this.metricComposites[i].label="COMPOSITE "+(i+1))}return t.prototype.addMetricComposite=function(){var t=new I;t.label="COMPOSITE "+(this.metricComposites.length+1),t.compositeName="",t.members=[{}],t.enabled=!0,t.clickThrough="",t.hideMembers=!0,t.showName=!0,t.showValue=!0,t.animateMode="all",t.thresholdLevel=0,t.newTabEnabled=!0,t.sanitizeURLEnabled=!0,t.sanitizedURL="",this.metricComposites.push(t)},t.prototype.removeMetricComposite=function(t){this.metricComposites=l.a.without(this.metricComposites,t);for(var e=0;e<this.metricComposites.length;e++)this.metricComposites[e].label="COMPOSITE "+(e+1);this.$scope.ctrl.panel.savedComposites=this.metricComposites,this.$scope.ctrl.refresh()},t.prototype.addMetricToComposite=function(t){void 0===t.members?t.members=[{}]:t.members.push({}),this.$scope.ctrl.refresh()},t.prototype.removeMetricFromComposite=function(t,e){t.members=l.a.without(t.members,e),this.$scope.ctrl.refresh()},t.prototype.matchComposite=function(t){for(var e=0;e<this.metricComposites.length;e++){var a=this.metricComposites[e],r=Object(f.stringToJsRegex)(a.compositeName),o=t.match(r);if(o&&o.length>0&&a.enabled)return e}return-1},t.prototype.resolveCompositeTemplates=function(){var t=this,e=[];return this.metricComposites.forEach((function(a){t.templateSrv.replace(a.compositeName,t.templateSrv.ScopedVars,"csv").split(",").forEach((function(t){e.push(o(o({},a),{compositeName:t}))}))})),e},t.prototype.resolveMemberTemplates=function(t,e){var a=this;void 0===e&&(e=this.templateSrv.ScopedVars);var r=[],i=/\$(\w+)|\[\[([\s\S]+?)(?::(\w+))?\]\]|\${(\w+)(?:\.([^:^\}]+))?(?::(\w+))?}/g;return t.forEach((function(t){if(t.seriesName){var s=t.seriesName.match(i);s&&s.length>0?s.forEach((function(i){a.templateSrv.replace(i,e,"csv").split(",").forEach((function(e){var a=t.seriesName.replace(s,e);r.push(o(o({},t),{seriesName:a}))}))})):r.push(t)}})),r},t.prototype.resolveMemberAliasTemplates=function(t,e){var a={};return e.forEach((function(t,e){a[e]={text:e,value:t}})),e.groups&&Object.keys(e.groups).forEach((function(t){a[t.replace(/\s+/g,"_")]={text:t,value:e.groups[t]}})),this.templateSrv.replace(t,a)},t.prototype.applyComposites=function(t){for(var e=new Array,a=new Array,r=this.resolveCompositeTemplates(),i=0;i<r.length;i++){var s=new Array,n=r[i];if(n.enabled){for(var h=null,p=this.resolveMemberTemplates(n.members,o(o({},this.templateSrv.ScopedVars),{compositeName:{text:"compositeName",value:n.compositeName}})),u=0;u<p.length;u++)for(var c=p[u],d=0;d<t.length;d++)if(void 0!==c.seriesName){var m=Object(f.stringToJsRegex)(c.seriesName).exec(t[d].name);if(m&&m.length>0){var v=t[d];if(c.alias&&c.alias.length>0&&(v.displayName=this.resolveMemberAliasTemplates(c.alias,m)),s.push(d),n.hideMembers&&e.push(d),n.clickThrough&&n.clickThrough.length>0){var g=this.templateSrv.replaceWithText(n.clickThrough);g=_.tranformComposite(n.compositeName,g),g=_.tranformSingleMetric(d,g,t),g=_.tranformNthMetric(g,t),v.clickThrough=g,v.sanitizedURL=this.$sanitize(g)}}}if(0!==s.length){for(var y=this.$scope?this.$scope.ctrl.panel.polystat.polygonGlobalFillColor:"#F00",b=0;b<s.length;b++){v=t[w=s[b]];h=null===h?v:L(h,v,y)}if(null!==h){var x=h.shallowClone();x.name=n.compositeName;for(d=0;d<s.length;d++){var w=s[d];x.members.push(o(o({},t[w]),{name:t[w].displayName||t[w].name}))}x.thresholdLevel=h.thresholdLevel,x.showName=n.showName,x.showValue=n.showValue,x.animateMode=n.animateMode,x.newTabEnabled=n.newTabEnabled,x.sanitizeURLEnabled=n.sanitizeURLEnabled,x.isComposite=!0,a.push(x)}}}}Array.prototype.push.apply(t,a),e.sort((function(t,e){return e-t}));for(i=t.length;i>=0;i--)l.a.includes(e,i)&&t.splice(i,1);return t},t.prototype.metricNameChanged=function(t){this.$scope.ctrl.refresh()},t.prototype.toggleHide=function(t){t.enabled=!t.enabled,this.$scope.ctrl.refresh()},t}(),V=function(){function t(){}return t.generate=function(e,a,r){for(var o=[],i=0;i<a.length;i++){var s=e.ctrl.dashboard.formatDate(a[i].timestamp,"YYYY-MM-DD HH:mm:ss"),n="";if("triggered"===r.tooltipDisplayMode)if(0===t.getTriggeredCount(a[i])){r.tooltipTimestampEnabled&&(n='\n              <div class="polystat-panel-tooltip-time">'+s+"</div>\n            ");var h='\n          <div class="polystat-panel-tooltip-displaytext-empty-compositename">'+a[i].name+'</div>\n          <div class="polystat-panel-tooltip-displaytext-empty">'+r.tooltipDisplayTextTriggeredEmpty+"</div>\n          "+n+"\n          ";o.push(h);continue}var p=[];if(r.tooltipTimestampEnabled&&(n='\n          <tr>\n            <td colspan="2" style="text-align: center;" class="graph-tooltip-time">'+s+"</td>\n          </tr>\n        "),p.push('\n        <table width="100%" class="polystat-panel-tooltiptable">\n        <thead>\n          <tr>\n            <th style="text-align: left;">Name</th>\n            <th style="text-align: right;">Value</th>\n          </tr>\n        </thead>\n        <tfoot>\n          '+n+"\n        </tfoot>\n        <tbody>\n      "),a[i].members.length>0)for(var u=l.a.orderBy(a[i].members,[e.ctrl.panel.polystat.tooltipPrimarySortField,e.ctrl.panel.polystat.tooltipSecondarySortField],[e.ctrl.panel.polystat.tooltipPrimarySortDirection,e.ctrl.panel.polystat.tooltipSecondarySortDirection]),c=0;c<u.length;c++){var d=u[c],m='\n            <tr>\n              <td style="text-align: left; color: '+d.color+'">'+d.name+'</td>\n              <td style="text-align: right; color: '+d.color+'">'+d.valueFormatted+"</td>\n            </tr>\n          ";switch(r.tooltipDisplayMode){case"triggered":0!==d.thresholdLevel&&p.push(m);break;default:p.push(m)}}else{m='\n        <tr>\n          <td style="text-align: left; color: '+a[i].color+'">'+a[i].name+'</td>\n          <td style="text-align: right; color: '+a[i].color+'">'+a[i].valueFormatted+"</td>\n        </tr>\n        ";switch(r.tooltipDisplayMode){case"triggered":0!==a[i].thresholdLevel&&p.push(m);break;default:p.push(m)}}p.push("</tbody></table>"),o.push(p.join("\n"))}return o},t.getTriggeredCount=function(t){var e=0;0!==t.thresholdLevel&&e++;for(var a=0;a<t.members.length;a++)0!==t.members[a].thresholdLevel&&e++;return e},t}(),$=function(t){function e(e,a,r,o){var i=t.call(this,e,a)||this;return i.$sanitize=o,i.animationModes=[{value:"all",text:"Show All"},{value:"triggered",text:"Show Triggered"}],i.displayModes=[{value:"all",text:"Show All"},{value:"triggered",text:"Show Triggered"}],i.shapes=[{value:"hexagon_pointed_top",text:"Hexagon Pointed Top"},{value:"circle",text:"Circle"},{value:"square",text:"Square"}],i.fontSizes=[4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,22,24,26,28,30,32,34,36,38,40,42,44,46,48,50,52,54,56,58,60,62,64,66,68,70],i.unitFormats=c.a.getUnitFormats(),i.operatorOptions=[{value:"avg",text:"Average"},{value:"count",text:"Count"},{value:"current",text:"Current"},{value:"delta",text:"Delta"},{value:"diff",text:"Difference"},{value:"first",text:"First"},{value:"logmin",text:"Log Min"},{value:"max",text:"Max"},{value:"min",text:"Min"},{value:"name",text:"Name"},{value:"last_time",text:"Time of Last Point"},{value:"time_step",text:"Time Step"},{value:"total",text:"Total"}],i.sortDirections=[{value:"asc",text:"Ascending"},{value:"desc",text:"Descending"}],i.sortFields=[{value:"name",text:"Name"},{value:"thresholdLevel",text:"Threshold Level"},{value:"value",text:"Value"}],i.sortOptions=[{value:0,text:"Disabled"},{value:1,text:"Alphabetical (asc)"},{value:2,text:"Alphabetical (desc)"},{value:3,text:"Numerical (asc)"},{value:4,text:"Numerical (desc)"},{value:5,text:"Alphabetical (case-insensitive, asc)"},{value:6,text:"Alphabetical (case-insensitive, desc)"}],i.panelDefaults={savedComposites:[],savedOverrides:[],colors:["#299c46","rgba(237, 129, 40, 0.89)","#d44a3a"],polystat:{animationSpeed:2500,columns:"",columnAutoSize:!0,displayLimit:100,defaultClickThrough:"",defaultClickThroughNewTab:!1,defaultClickThroughSanitize:!1,fontAutoScale:!0,fontSize:12,fontType:"Roboto",globalUnitFormat:"short",globalDecimals:2,globalDisplayMode:"all",globalOperatorName:"avg",globalDisplayTextTriggeredEmpty:"OK",gradientEnabled:!0,hexagonSortByDirection:"asc",hexagonSortByField:"name",maxMetrics:0,polygonBorderSize:2,polygonBorderColor:"black",polygonGlobalFillColor:"#0a50a1",radius:"",radiusAutoSize:!0,rows:"",rowAutoSize:!0,shape:"hexagon_pointed_top",tooltipDisplayMode:"all",tooltipDisplayTextTriggeredEmpty:"OK",tooltipFontSize:12,tooltipFontType:"Roboto",tooltipPrimarySortDirection:"desc",tooltipPrimarySortField:"thresholdLevel",tooltipSecondarySortDirection:"desc",tooltipSecondarySortField:"value",tooltipTimestampEnabled:!0}},l.a.defaultsDeep(i.panel,i.panelDefaults),i.d3DivId="d3_svg_"+i.panel.id,i.containerDivId="container_"+i.d3DivId,i.initialized=!1,i.panelContainer=null,i.templateSrv=r,i.svgContainer=null,i.panelWidth=null,i.panelHeight=null,i.polystatData=new Array,i.d3Object=null,i.data=[],i.series=[],i.polystatData=[],i.tooltipContent=[],i.migrateSortDirections(),i.overridesCtrl=new A(e,r,o,i.panel.savedOverrides),i.compositesManager=new U(e,r,o,i.panel.savedComposites),i.events.on(f.PanelEvents.editModeInitialized,i.onInitEditMode.bind(i)),i.events.on(f.PanelEvents.dataReceived,i.onDataReceived.bind(i)),i.events.on(f.PanelEvents.dataError,i.onDataError.bind(i)),i.events.on(f.PanelEvents.dataSnapshotLoad,i.onDataReceived.bind(i)),i}return e.$inject=["$scope","$injector","templateSrv","$sanitize"],function(t,e){function a(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(a.prototype=e.prototype,new a)}(e,t),e.prototype.migrateSortDirections=function(){"asc"===this.panel.polystat.hexagonSortByDirection&&(this.panel.polystat.hexagonSortByDirection=1),"desc"===this.panel.polystat.hexagonSortByDirection&&(this.panel.polystat.hexagonSortByDirection=2),"asc"===this.panel.polystat.tooltipPrimarySortDirection&&(this.panel.polystat.tooltipPrimarySortDirection=1),"desc"===this.panel.polystat.tooltipPrimarySortDirection&&(this.panel.polystat.tooltipPrimarySortDirection=2),"asc"===this.panel.polystat.tooltipSecondarySortDirection&&(this.panel.polystat.tooltipSecondarySortDirection=1),"desc"===this.panel.polystat.tooltipSecondarySortDirection&&(this.panel.polystat.tooltipSecondarySortDirection=2)},e.prototype.onInitEditMode=function(){var t="public/plugins/"+this.panel.type+"/",e=t+"partials/editor.options.html";this.addEditorTab("Options",e,2);var a=t+"partials/editor.overrides.html";this.addEditorTab("Overrides",a,3);var r=t+"partials/editor.composites.html";this.addEditorTab("Composites",r,4)},e.prototype.setContainer=function(t){this.panelContainer=t,this.svgContainer=t},e.prototype.getPanelWidthFailsafe=function(){var t=0;if(void 0!==this.panel.gridPos){var e=Math.max(document.documentElement.clientWidth,window.innerWidth||0)/24;return t=Math.round(this.panel.gridPos.w*e)}if(void 0===this.panel.span)t=this.editModeInitiated?Math.max(document.documentElement.clientWidth,window.innerWidth):this.panelContainer.offsetParent.clientWidth;else{var a=Math.max(document.documentElement.clientWidth,window.innerWidth||0)/12;t=Math.round(this.panel.span*a)}return t},e.prototype.getPanelHeight=function(){var t=this.panel.height;if(void 0===t||""===t){if(t=String(this.height),void 0!==this.panel.span){var e=20;""!==this.panel.title&&(e=42),t=String(this.containerHeight-e)}void 0===t&&void 0===(t=this.row.height)&&(t="250")}return t=t.replace("px",""),parseInt(t,10)},e.prototype.clearSVG=function(){p()("#"+this.d3DivId).length&&p()("#"+this.d3DivId).remove(),p()("#"+this.d3DivId+"-panel").length&&p()("#"+this.d3DivId+"-panel").remove(),p()("#"+this.d3DivId+"-tooltip").length&&p()("#"+this.d3DivId+"-tooltip").remove()},e.prototype.renderD3=function(){this.setValues(this.data),this.clearSVG(),0===this.panelWidth&&(this.panelWidth=this.getPanelWidthFailsafe()),this.panelHeight=this.getPanelHeight();var t={top:0,right:0,bottom:0,left:0},e=this.panelWidth,a=this.panelHeight;t.top=0,void 0!==this.panel.span&&""!==this.panel.title&&(t.top=7),t.bottom=0;var r=this.panel.polystat;void 0===r.polygonBorderSize&&(r.polygonBorderSize=0),void 0===r.polygonBorderColor&&(r.polygonBorderColor="black");var o={width:e,height:a,radius:r.radius,radiusAutoSize:r.radiusAutoSize,tooltipFontSize:r.tooltipFontSize,tooltipFontType:r.tooltipFontType,data:this.polystatData,displayLimit:r.displayLimit,globalDisplayMode:r.globalDisplayMode,columns:r.columns,columnAutoSize:r.columnAutoSize,rows:r.rows,rowAutoSize:r.rowAutoSize,tooltipContent:this.tooltipContent,animationSpeed:r.animationSpeed,defaultClickThrough:this.getDefaultClickThrough(NaN),polystat:r};this.d3Object=new E(this.templateSrv,this.svgContainer,this.d3DivId,o),this.d3Object.draw()},e.prototype.removeValueMap=function(t){var e=l.a.indexOf(this.panel.valueMaps,t);this.panel.valueMaps.splice(e,1),this.render()},e.prototype.addValueMap=function(){this.panel.valueMaps.push({value:"",op:"=",text:""})},e.prototype.removeRangeMap=function(t){var e=l.a.indexOf(this.panel.rangeMaps,t);this.panel.rangeMaps.splice(e,1),this.render()},e.prototype.addRangeMap=function(){this.panel.rangeMaps.push({from:"",to:"",text:""})},e.prototype.onThresholdsChanged=function(t){this.panel.refresh()},e.prototype.link=function(t,e,a,r){if(t&&a){var o=e.find(".grafana-d3-polystat");o.append('<div style="width: 100%; height: 100%;" id="'+r.containerDivId+'"></div>');var i=o[0].childNodes[0];r.setContainer(i),e=e.find(".grafana-d3-polystat");this.events.on(f.PanelEvents.render,(function(){r.panelWidth=e.width(),r.panelWidth=e.width(),r.renderD3(),r.renderingCompleted()}))}},e.prototype.setValues=function(t){this.dataRaw=t,this.dataRaw&&this.dataRaw.length&&("table"===this.dataRaw[0].type?this.panel.transform="table":"docs"===this.dataRaw[0].type?this.panel.transform="json":"table"!==this.panel.transform&&"json"!==this.panel.transform||(this.panel.transform="timeseries_to_rows"));var e=this.panel.polystat;if(this.polystatData.length=0,this.series&&this.series.length>0)for(var a=0;a<this.series.length;a++){var r=this.series[a],o=k.TimeSeriesToPolystat(e.globalOperatorName,r);this.polystatData.push(o)}this.applyGlobalFormatting(this.polystatData),this.polystatData=l.a.orderBy(this.polystatData,[e.hexagonSortByField],[this.panel.polystat.hexagonSortByDirection]),this.overridesCtrl.applyOverrides(this.polystatData),this.polystatData=this.compositesManager.applyComposites(this.polystatData);for(a=0;a<this.polystatData.length;a++)0===this.polystatData[a].clickThrough.length&&(this.polystatData[a].clickThrough=this.getDefaultClickThrough(a),this.polystatData[a].newTabEnabled=e.defaultClickThroughNewTab,this.polystatData[a].sanitizeURLEnabled=e.defaultClickThroughSanitize,this.polystatData[a].sanitizedURL=this.$sanitize(this.polystatData[a].clickThrough));this.polystatData=this.filterByGlobalDisplayMode(this.polystatData),this.polystatData=function(t,e,a){if(0===a)return t;var r=Math.ceil(a/2),o=a%2==0;if(1===r){var i=t[e];t=l.a.sortBy(t,i)}else 2===r?t=l.a.sortBy(t,(function(t){var a=t[e].match(/.*?(\d+).*/);return!a||a.length<2?-1:parseInt(a[1],10)})):3===r&&(t=l.a.sortBy(t,(function(t){return l.a.toLower(t[e])})));return o&&(t=t.reverse()),t}(this.polystatData,"name",this.panel.polystat.hexagonSortByDirection),this.polystatData=l.a.orderBy(this.polystatData,this.sortByField([this.panel.polystat.hexagonSortByField]),[this.panel.polystat.hexagonSortByDirection]),this.tooltipContent=V.generate(this.$scope,this.polystatData,e)},e.prototype.sortByField=function(t){return isNaN(t.name)?t.name:Number(t.name)},e.prototype.applyGlobalFormatting=function(t){for(var e=0;e<t.length;e++){var a=c.a.valueFormats[this.panel.polystat.globalUnitFormat];if(a){var r=w(t[e].value,this.panel.polystat.globalDecimals);t[e].valueFormatted=a(t[e].value,r.decimals,r.scaledDecimals),t[e].valueRounded=c.a.roundValue(t[e].value,r.decimals)}t[e].color=this.panel.polystat.polygonGlobalFillColor}},e.prototype.filterByGlobalDisplayMode=function(t){var e=new Array,a=new Array;if("all"!==this.panel.polystat.globalDisplayMode){for(var r=t.length,o=0;o<r;o++){var i=t[o];i.isComposite&&a.push(i),i.thresholdLevel<1&&e.push(o)}for(o=t.length;o>=0;o--)l.a.includes(e,o)&&t.splice(o,1);0===t.length&&a.length>0&&(t=a)}return t},e.prototype.onDataError=function(t){console.log(t),this.onDataReceived([]),this.render()},e.prototype.onDataReceived=function(t){this.series=t.map(this.seriesHandler.bind(this));var e={value:0,valueFormatted:0,valueRounded:0};this.setValues(e),this.data=e,this.render()},e.prototype.seriesHandler=function(t){var e=new m.a({datapoints:t.datapoints,alias:t.target});return e.flotpairs=e.getFlotPairs(this.panel.nullPointMode),e},e.prototype.invertColorOrder=function(){var t=this.panel.colors[0];this.panel.colors[0]=this.panel.colors[2],this.panel.colors[2]=t,this.render()},e.prototype.validateAnimationSpeed=function(){var t=this.panel.polystat.animationSpeed,e=5e3;if(t&&!isNaN(parseInt(t,10))){var a=parseInt(t,10);e=a>=500?a:500}this.panel.polystat.animationSpeed=e,this.render()},e.prototype.validateDisplayLimit=function(){var t=this.panel.polystat.displayLimit,e=100;if(null===t)e=0;else if(!isNaN(parseInt(t,10))){var a=parseInt(t,10);a>=0&&(e=a)}this.panel.polystat.displayLimit=0===e?"":e,this.render()},e.prototype.validateColumnValue=function(){if(this.panel.polystat.columnAutoSize)this.panel.polystat.columns="";else{var t=this.panel.polystat.columns,e=1;if(t&&!isNaN(parseInt(t,10))){var a=parseInt(t,10);a>0&&(e=a)}this.panel.polystat.columns=e}this.render()},e.prototype.validateRowValue=function(){if(this.panel.polystat.rowAutoSize)this.panel.polystat.rows="";else{var t=this.panel.polystat.rows,e=1;if(t&&!isNaN(parseInt(t,10))){var a=parseInt(t,10);a>0&&(e=a)}this.panel.polystat.rows=e}this.render()},e.prototype.validateRadiusValue=function(){if(this.panel.polystat.radiusAutoSize)this.panel.polystat.radius="";else{var t=this.panel.polystat.radius,e=25;if(null!==t&&!isNaN(parseInt(t,10))){var a=parseInt(t,10);a>0&&(e=a)}this.panel.polystat.radius=e}this.render()},e.prototype.validateBorderSizeValue=function(){var t=this.panel.polystat.polygonBorderSize,e=2;if(null!==t&&!isNaN(parseInt(t,10))){var a=parseInt(t,10);a>=0&&(e=a)}this.panel.polystat.polygonBorderSize=e,this.render()},e.prototype.updatePolygonBorderColor=function(){this.panel.polystat.polygonBorderColor=S(this.panel.polystat.polygonBorderColor),this.render()},e.prototype.updatePolygonGlobalFillColor=function(){this.panel.polystat.polygonGlobalFillColor=S(this.panel.polystat.polygonGlobalFillColor),this.render()},e.prototype.getDefaultClickThrough=function(t){var e=this.panel.polystat.defaultClickThrough;return e=_.tranformSingleMetric(t,e,this.polystatData),e=_.tranformNthMetric(e,this.polystatData),e=this.templateSrv.replaceWithText(e)},e.prototype.setGlobalUnitFormat=function(t){this.panel.polystat.globalUnitFormat=t.value},e.templateUrl="partials/template.html",e}(s.MetricsPanelCtrl),B=a(7),H=a.n(B),j=function(){function t(t){this.$scope=t,this.thresholdStates=[{value:0,text:"ok"},{value:1,text:"warning"},{value:2,text:"critical"},{value:3,text:"custom"}],this.thresholds=[],t.thresholds&&(this.thresholds=function(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(i(arguments[e]));return t}(t.thresholds))}return t.$inject=["$scope"],t.prototype.sortThresholds=function(){this.thresholds=l.a.orderBy(this.thresholds,["value"],["asc"])},t.prototype.doRefresh=function(){this.thresholds&&this.thresholds.length?this.$scope.thresholds=this.thresholds:this.$scope.thresholds=void 0,this.$scope.callback()},t.prototype.addThreshold=function(){this.thresholds.push({value:0,state:0,color:"#299c46"}),this.sortThresholds(),this.doRefresh()},t.prototype.setThresholdColor=function(t){t.color=S(t.color),this.doRefresh()},t.prototype.updateThresholdColor=function(t){var e=this.$scope.colors;t.color=e[t.state],this.doRefresh()},t.prototype.removeThreshold=function(t){this.thresholds=l.a.without(this.thresholds,t),this.sortThresholds(),this.doRefresh()},t}();H.a.directive("polyThresholds",(function(){return{controller:j,controllerAs:"ctrl",restrict:"E",scope:{thresholds:"=",colors:"=",override:"=?",callback:"&"},templateUrl:"./public/plugins/grafana-polystat-panel/partials/thresholds.html"}})),a.d(e,"PanelCtrl",(function(){return $})),Object(s.loadPluginCss)({dark:"plugins/grafana-polystat-panel/styles/dark.css",light:"plugins/grafana-polystat-panel/styles/light.css"})}])}));